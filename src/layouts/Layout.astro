---
import '../styles/global.css';
import ConsentManager from '../components/ConsentManager';
import GoogleAnalytics from '../components/GoogleAnalytics';
import LanguageSync from '../components/LanguageSync';
import { languages } from '../i18n/config';

// Supports weights 300-700
import '@fontsource/inter/300.css';
import '@fontsource/inter/400.css';
import '@fontsource/inter/500.css';
import '@fontsource/inter/600.css';
import '@fontsource/inter/700.css';

// Supports weights 400-800
import '@fontsource/poppins/400.css';
import '@fontsource/poppins/500.css';
import '@fontsource/poppins/600.css';
import '@fontsource/poppins/700.css';
import '@fontsource/poppins/800.css';

interface Props {
	title: string;
	description: string;
	lang?: string;
	keywords?: string;
}

const { title, description, lang = 'es', keywords } = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang={lang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		{keywords && <meta name="keywords" content={keywords} />}
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />

		<style>
			html.loading-i18n body {
				opacity: 0;
			}
			html.i18n-ready body {
				opacity: 1;
				transition: opacity 0.1s ease-in;
			}
		</style>

		<script is:inline>
			(function () {
				document.documentElement.classList.add('loading-i18n');

				function getStoredLanguage() {
					try {
						const stored = localStorage.getItem('language');
						if (stored && ['es', 'en', 'pt', 'fr', 'it'].includes(stored)) {
							return stored;
						}
					} catch (error) {
						console.error('Error reading language from localStorage:', error);
					}
					return null;
				}

				function getBrowserLanguage() {
					const browserLang = navigator.language.split('-')[0];
					const supportedLangs = ['es', 'en', 'pt', 'fr', 'it'];
					return supportedLangs.includes(browserLang) ? browserLang : 'es';
				}

				function saveLanguage(lang) {
					try {
						localStorage.setItem('language', lang);
					} catch (error) {
						console.error('Error saving language to localStorage:', error);
					}
				}

				let currentLang = getStoredLanguage();

				if (!currentLang) {
					currentLang = getBrowserLanguage();
					saveLanguage(currentLang);
				}

				document.documentElement.lang = currentLang;
				window.__INITIAL_LANGUAGE__ = currentLang;
			})();
		</script>

		{
			Object.keys(languages).map((l) => (
				<link rel="alternate" hreflang={l} href={new URL(`/${l === 'es' ? '' : l}`, Astro.site)} />
			))
		}
		<link rel="alternate" hreflang="x-default" href={Astro.site} />

		<meta name="robots" content="index, follow" />
		<link rel="canonical" href={canonicalURL} />

		<meta name="author" content="Residencia Nueva Edad" />
		<meta name="copyright" content="Residencia Nueva Edad" />
		<meta name="application-name" content={title} />

		<!-- Open Graph -->
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:type" content="website" />
		<meta property="og:url" content={Astro.url} />
		<meta property="og:image" content={new URL('/og-image.jpg', Astro.url)} />
		<meta property="og:site_name" content="Residencia Nueva Edad" />
		<meta property="og:locale" content={lang} />

		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={new URL('/og-image.jpg', Astro.url)} />

		<!-- Load i18n client script early with defer -->
		<script>
			import '@/scripts/i18n-client';
		</script>

		<title>{title}</title>
	</head>
	<body class="w-full overflow-x-hidden">
		<slot />
		<LanguageSync client:only="react" />
		<ConsentManager client:only="react" />
		<GoogleAnalytics client:only="react" />
	</body>
</html>
